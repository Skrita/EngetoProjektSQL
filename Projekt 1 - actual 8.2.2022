SELECT 
	cb.`date`,
	cb.COUNTRY,
	CASE 
		WHEN (WEEKDAY(`date`) in (5,6)) then 1
		WHEN (WEEKDAY(`date`) in (0,1,2,3,4)) then 0
		ELSE 'Chybi data'
		END AS '1.1-WEEKEND indic.',	
		(4+(CASE 
			WHEN month(`date`) in (1,2,12) then 0 
			WHEN month(`date`) in (3,4,5) then 1
			WHEN month(`date`) in (6,7,8) then 2 
			WHEN month(`date`) in (9,10,11) then 3 
			END  
		- 
		CASE WHEN  c.north > 0 then 0
			ELSE 2
			end))%4 as '1.2-Meteo season by hemi.'
		/* north - rozlisovac severni a jizni polokoule, 4+ a modulo pro spravne formatovani)*/
	/*CONCAT(c.north,' ', COUNTRY) as control severu*/
	,
	c.population_density as '2.1-Hustota zalidneni',
	ROUND(e.gdp/e.population,2) AS '2.2-HDP na obyvatele', /* mozna problematicke pri kontrole vypadalo ok, ale rozhodne to neni osetrene*/
	e.gini AS '2.3-GINI coef',
	e.mortaliy_under5 AS '2.4 Detska umrtnost',
	c.median_age_2018 AS '2.5 Median veku 2018',
	rel.*,
	lexp.rozdil_1965_2015 AS '2.7 Rozdil v doziti mezi roky 1965 a 2015'
FROM COVID19_BASIC AS CB
LEFT JOIN COUNTRIES AS C 
	ON CB.country = C.COUNTRY 
JOIN (SELECT e.gdp, e.gini, e.population, e.country, e.mortaliy_under5 
	FROM ECONOMIES AS E 
	WHERE e.YEAR=2020) AS E
ON cb.country= E.COUNTRY
JOIN (SELECT
	r.country,
	round(chr.population/p.total_population *100, 1) AS Christianity, 
	round(isl.population/p.total_population *100, 1) AS Islam,
	round(unr.population/p.total_population *100, 1) AS Unaffiliated, 
	round(hin.population/p.total_population *100, 1) AS Hinduism,
	round(bud.population/p.total_population *100, 1) AS Buddhism,
	round(fre.population/p.total_population *100, 1) AS Folk,
	round(ore.population/p.total_population *100, 1) AS Other,
	round(jud.population/p.total_population *100, 1) AS Judaism
	FROM religions AS r
	JOIN (SELECT SUM(population) AS total_population, country
		FROM religions AS r2
		WHERE `year`= 2020
		GROUP BY country, `year`
	) AS p	
	ON r.country =p.country 
	AND `year` =2020
JOIN (SELECT population, country
		FROM religions AS r
		WHERE `year`= 2020 AND r.religion ='Christianity'
		GROUP BY country, `year`
	) AS chr	
	ON r.country =chr.country 
JOIN (SELECT population, country
		FROM religions AS r
		WHERE `year`= 2020 AND r.religion ='Islam'
		GROUP BY country, `year`
	) AS isl	
	ON r.country =isl.country 
JOIN (SELECT population, country
		FROM religions AS r
		WHERE `year`= 2020 AND r.religion ='Unaffiliated Religions'
		GROUP BY country, `year`
	) AS unr	
	ON r.country =unr.country 
JOIN (SELECT population, country
		FROM religions AS r
		WHERE `year`= 2020 AND r.religion ='Hinduism'
		GROUP BY country, `year`
	) AS hin	
	ON r.country =hin.country 
JOIN (SELECT population, country
		FROM religions AS r
		WHERE `year`= 2020 AND r.religion ='Buddhism'
		GROUP BY country, `year`
	) AS bud	
	ON r.country =bud.country
JOIN (SELECT population, country
		FROM religions AS r
		WHERE `year`= 2020 AND r.religion ='Folk Religions'
		GROUP BY country, `year`
	) AS fre	
	ON r.country =fre.country
JOIN (SELECT population, country
		FROM religions AS r
		WHERE `year`= 2020 AND r.religion ='Other Religions'
		GROUP BY country, `year`
	) AS ore	
	ON r.country =ore.country
JOIN (SELECT population, country
		FROM religions AS r
		WHERE `year`= 2020 AND r.religion ='Judaism'
		GROUP BY country, `year`
	) AS jud	
	ON r.country =jud.country
GROUP BY r.country) AS rel
ON rel.country = cb.country
JOIN (SELECT le2015.country, le2015.life_expectancy AS 'Doziti 2015', le1965.life_expectancy AS 'Doziti 1965', round( le2015.life_expectancy/le1965.life_expectancy,3)*100 AS 'Percentile change', round(le2015.life_expectancy-le1965.life_expectancy,2) AS rozdil_1965_2015
FROM (SELECT * 
	FROM life_expectancy AS le
	WHERE `year` =2015) AS le2015
LEFT JOIN (SELECT * 
	FROM life_expectancy AS le
	WHERE `year` =1965) AS le1965
ON le2015.country=le1965.country
WHERE le2015.life_expectancy-le1965.life_expectancy) AS lexp
ON lexp.country=cb.country
GROUP BY cb.country
;
